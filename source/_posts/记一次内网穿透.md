---
title: 记 frp 实现内网穿透
tags:
  - 分享
  - 网络
categories: 项目经历
abbrlink: dae1adad
date: 2021-09-12 15:30:53
---

## 前言

啊，服务器配置太低，只能把服务配置在本地，但是校园网哪来的公网 IP，无奈只能穿透了捏~

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210912153717.webp" alt="img" style="zoom:50%;" />

<!--more-->

## 简介

`frp` 是一个可用于内网穿透的高性能的反向代理应用，支持 `tcp`, `udp` 协议，为 ` http ` 和 `https` 应用协议提供了额外的能力，且尝试性支持了点对点穿透。可以将内网服务以安全、便捷的方式通过具有公网 IP 节点的中转暴露到公网。

## 工具

> 提供服务的客户端（我这里是 Win10）
>
> 拥有公网 ip 的服务端（我这里是 CentOS8）
>
> 一个@解析到服务端 ip 的域名
>
> frp

## 服务端篇

### 下载 

[FRP 下载地址](https://github.com/fatedier/frp/releases)

选择你服务器内核对应的压缩包即可，下载完成后解压

### 配置

可以看到软件目录一共有两个程序、四个配置文件

> frps 表示 frp server
>
> frpc 表示 frp client
>
> frps.ini 是服务端配置文件
>
> frpc.ini 是客户端配置文件 
>
> frps_full.ini 是服务端的配置文件模板
>
> frpc_full.ini 是客户端的配置文件模板

配置服务端文件 `frps.ini`：

```bash
[common]
#监听的ip，通常为0.0.0.0，意为监听所有的地址
bind_addr = 0.0.0.0			
#与客户端绑定端口须一致
bind_port = 7000		
#监听 HTTP 请求端口
vhost_http_port = 5089					
#域名设置
subdomain_host = yourdomain.com 	
#dashboard 用户名
dashboard_user = username
#dashboard 密码
dashboard_pwd = passwd			
#dashboard 端口，启动成功后可通过浏览器访问如http://ip:23333
dashboard_port = 23333 		
#设置服务端token，对应客户端也需要配置相同
token = 1145141818     						
```

### 运行

```bash
./frps -c ./frps.ini
```

![](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210912160616.png)

+ 记得打开相应的防火墙以及安全组



### 设置服务

```bash
vim /etc/systemd/system/frps.service
```

添加以下内容：

```
[Unit]
Description=frps daemon
After=syslog.target  network.target
Wants=network.target
 
[Service]
Type=simple
ExecStart=/usr/local/frp/frps -c /usr/local/frp/frps.ini
Restart= always
RestartSec=1min
 
[Install]
WantedBy=multi-user.target
```

+ `ExecStart` 根据 frp 安装目录自行更改

现在就可以 `systemctl` 来控制 frp 啦

## 客户端篇

### 下载 

[FRP 下载地址](https://github.com/fatedier/frp/releases)

选择你服务器内核对应的压缩包即可，下载完成后解压

### 配置

配置客户端文件 `frpc.ini`：

```bash
[common]
# 服务器IP或者地址
server_addr = address or domain
# 服务器提供的端口号(需与客户端一致)
server_port = 7000           
#设置客户端token(需与客户端一致)
token = 1145141818

[Asoul]
type = http
local_ip = 127.0.0.1
#内网服务放置的端口
local_port = 8080
#二级域名设置
subdomain = test
```

+ 这里我只配置了一个 web 应用的穿透，更多的比如 ssh 登录，远程桌面等等见参考

+ 访问服务的方式是：`subdomain.domain.com:vhost_http_port`

### 运行

```bash
\frpc.exe -c .\frpc.ini
```

![image-20210912162600590](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210912162600.png)

### 设置服务

新建一个 `vbs`：

```vbscript
Copyset ws=WScript.CreateObject("WScript.Shell")
ws.Run "{yourpath}\frpc.exe -c {yourpath}\frpc.ini",0
```

`win`+`R` 运行打开 `shell:startup` 把该文件放进去即可嘞。

## Window 服务

介绍个好用的玩意儿 [winsw](https://github.com/kohsuke/winsw)，它可以将 Windows 上的任何一个程序注册为服务，这比 `shell:startup` 方便多嘞，它的使用类似于 Linux 平台上的 `systemctl`，只不过其的配置文件是用 xml 格式写的

### 下载

https://github.com/winsw/winsw/releases/

如果电脑有安装 `.NET Framework 4.6.1` 以上版本就可以选择 `WinSW-net461.exe`，反之选择 x64 或者 x86 版本

### 配置

1. 将下载好的 exe 文件改个名字 `winsw.exe`
2. 新建一个 `winsw` 目录，移动 `winsw.exe` 并将其添加进系统环境变量中
3. 在该目录下新建一个 `frp.xml` 文件

```xml
<service>
  <!-- 该服务的唯一标识 -->
  <id>frp</id>
  <!-- 该服务的名称 -->
  <name>frpc</name>
  <!-- 该服务的描述 -->
  <description>frpc客户端 这个服务用 frpc 实现内网穿透</description>
  <!-- 要运行的程序路径 -->
  <executable>{yourpath}\frpc.exe</executable>
  <!-- 携带的参数 -->
  <arguments>-c {yourpath}\frpc.ini</arguments>
  <!-- 第一次启动失败 60秒重启 -->
  <onfailure action="restart" delay="60 sec" />
  <!-- 日志模式 -->
  <logmode>append</logmode>
  <!-- 指定日志文件目录(相对于executable配置的路径) -->
  <logpath>frplogs</logpath>
</service>
```

4. 安装服务

```powershell
 winsw install {yourpath}\winsw\frp.xml
```

5. 启动服务

```powershell
 winsw start {yourpath}\winsw\frp.xml
```

```
//全部命令：
//注册服务
winsw.exe install xxx
//卸载服务
winsw.exe uninstall xxx
//启动服务
winsw.exe start xxx
//停止服务
winsw.exe stop xxx
//重启服务
winsw.exe restart xxx
//查看状态
winsw.exe status xxx
```



## 参考

http://kan.lol/posts/c067e7e3/

https://blog.csdn.net/nextyu/article/details/78284663
