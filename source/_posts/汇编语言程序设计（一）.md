---
title: 汇编语言程序设计（一）
tags:
  - 笔记
  - 汇编
category: 汇编语言程序设计
katex: true
abbrlink: fdbc8e77
---



## 前言

中秋节，真不戳

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220906105428.jpg" alt="100953677_p0_master1200" style="zoom:67%;" />

<!--more-->

一些常用名词：

+ 字长（数据宽度）：微处理器一次可以直接处理的二进制数码的 **位数**，它通常取决于微处理器内部 **通用寄存器** 的位数和 **数据总线** 的宽度
+ 寻址能力：指 CPU 能直接存取数据的 **内存地址** 的范围，它由 CPU 的 **地址总线** 的数目决定
+ 主频（时钟频率）：用来表示微处理器的运行速度，主频越高 ，表明微处理器运行越快，主频的单位是 MHz、GHz
+ MIPS（Millions of Instruction Per Second）：每秒钟能执行多少百万条指令
+ 微处理器的集成度：微处理器芯片上集成的晶体管数目

## 16 位微处理器内部结构

> Intel 8086 CPU 与随后推出的 8088 CPU 比较类似。8086CPU 是 16 位微处理器，它有 16 根数据线和 20 根地址线，所以可寻址的地址空间是 $2^{20}B = 1MB$。8088CPU 的内部寄存器、内部运算部件以及内部操作都是按 16 位设计的，但对外的数据总线只有 8 位，在处理一个 16 位数据时，8088 需要两步操作，因而称 8088 是准 16 位微处理器。后来推出的 80286，它的内部结构除了具备 8086/8088 最基本的功能外，还增加了虚拟存储、特权保护、任务管理等功能，所以支持多用户和多任务系统。

### 内部结构

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/8086/8088%E7%BB%93%E6%9E%84.png" alt="image-20220906091341708" style="zoom:80%;" />

+ **总线接口单元** 由段寄存器（`CS`、`DS`、`SS`、`ES`）、指令指针寄存器（`IP`)、内部暂存器、指令队列、地址加法器及总线控制电路组成。它的主要作用是负责执行所有的外部总线操作
+ **执行单元** 由通用寄存器、运算数暂存器、算术逻辑单元（`ALU`）、标志寄存器（`FLAGS`）及 `EU` 控制电路组成。它的主要作用是分析和执行指令
+ 指令队列主要使 `EU` 和 `BIU` 并行工作，取指令操作、分析指令操作重叠进行，从而形成了 **两级指令流水线结构**，减少了 CPU 为取指令而必须等待的时间，提高了 CPU 的利用率，加快了整机运行速度，也降低了对存储器存取速度的要求

### 寄存器结构

#### 通用寄存器

8086/8088 微处理器的执行单元中有 8 个 **16 位** 的通用寄存器，这些寄存器都可以存放数据或地址，并能进行 **16 位和 8 位** 的数据运算

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220906092902.png" alt="通用寄存器" style="zoom:67%;" />

+ 数据寄存器
  + `AX` 称为累加器（Accumulator）使用频度最高，用于算术、逻辑运算以及与外设传送信息
  + `BX` 称为基址寄存器（Basc Address Rcgister）常用作存放存储器地址
  + `CX` 称为计数器（Counter）作为循环和串操作等指令中的隐含计数器
  + `DX` 称为数据寄存器（Data Register）常用来存放双字长数据的高 16 位，或存放外设端口地址
  + 这四个数据寄存器可作为两个独立的 **8 位寄存器** 使用，低位字节的寄存器分别称为 `AL,BL,CL,DL`，高位字节的寄存器分别称为 `AH,BH,CH,DH`
+ 变址寄存器
  + `SI` 称为源变址寄存器（Source Index）
  + `DI` 是目的变址寄存器（Destination Index）
  + 常用于存储器变址寻址方式提供地址。在串操作类指令中，用于存放串首或串尾数据单元的偏移地址
+ 指针寄存器
  + `SP` 为堆栈指针寄存器（Stack Pointer），指示堆栈段栈顶的位置（偏移地址）
  + `BP` 为基址指针寄存器（Base Pointer）
  + `SP` 和 `BP` 寄存器与 `SS` 段寄存器联合使用以确定堆栈段中的存储单元地址

#### 段寄存器

CPU 内部有 4 个段寄存器。8086/8088 CPU 对寻址的 $1MB$ 内存区域是分段管理的，定义的代码段用于存放指令代码，数据段和附加数据段用于存放数据，堆栈段是按照先进后出的访问原则组织起来的一段内存区域。这 4 个段寄存器为存储器分段管理技术提供了硬件支持

+ `CS` 称为代码段寄存器，用于存放 **代码段** 的 **段基址**
+ `DS` 称为数据段寄存器；`ES` 称为附加段寄存器，两者都用于存放 **数据段** 和 **附加数据段** 的 **段基址**
+ `SS` 称为堆栈段寄存器，用于存放 **堆栈段** 的 **段基址**

#### 指令指针寄存器

`IP`（Instruction Pointer）为指令指针寄存器，指示内存中指令的位置。随着指令的执行，IP 将自动修改以指示下一条指令所在位置。`IP` 是一个 **专用寄存器**，与 `CS` 联合使用以确定下一条指令的存储单元地址

#### 标志寄存器

执行单元 `EU` 中有一个标志寄存器 `FLAGS`，16 位的 `FLAGS` 可分为标志位和控制位，**标志位** 指明程序运行时微处理器的实时状态；**控制位** 由程序设计者设置，以控制 CPU 进行某种操作

## 32 位微处理器内部结构

> Pentium 微处理器的内部寄存器长度都为 $32$ 位，但外部数据总线不像 80386 和 **80486** 那样是 $32$ 位，而是 $64$ 位，总线传输速度高达 $66MHz$。同时它具有 $32$ 位地址总线，可直接寻址 $4GB$ 的物理内存空间。它有两条相对独立的指令并行流水线，即 U 流水线和 V 流水线

### 内部结构

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220906094633.png" alt="image-20220906094633289" style="zoom:80%;" />

+ **总线接口单元** 实现 CPU 与系统总线的连接，其中包括 64 位数据线、32 位地址线和众多控制信号线，以此实现相互之间的信息交换，并产生相应的总线周期信号
+ **分段分页单元** 完成将各种地址映射到内存物理地址的功能
+ **高速缓存** 即 Cache，是容量较小、速度很高的可读写 RAM，用来存放 CPU 最近要使用的数据和指令，Cache 可以加快 CPU 存取数据的速度，减轻总线负担。在 Pentium 微处理器内部，指令 Cache 和数据 Cache 是分开的，目的是提高访问的 **命中率**
+ **指令预取部件** 每次可以取两条指令，如果是简单指令，并且后一条指令不依赖前一条指令的执行结果，那么，指令预取部件便将两条指令分别送到 U 流水线和 V 流水线独立执行
+ **指令 Cache、指令预取部件** 将原始指令送到指令译码器，分支目标缓冲器则在遇到分支转移指令时用来预测转移是否发生
+ **浮点处理单元** 主要用于浮点运算，内含专用的加法器、乘法器和除法器，加法器和乘法器均能在 3 个时钟周期内完成相应的运算，除法器则在每个时钟周期产生 2 位二进制商
+ **控制 ROM** 中含有 Pentium 微处理器的微代码，控制部件直接控制流水线操作。

### 寄存器结构

80486 内部寄存器分为四类：基本结构寄存器、浮点寄存器、系统级寄存器、调试测试寄存器。应用程序只能访问基本结构寄存器和浮点寄存器。这里只介绍基本结构寄存器，**除了标志寄存器外，其余寄存器的命名和使用方法都没有改变**。

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220906095449.png" alt="image-20220906095449778" style="zoom:80%;" />

#### 通用寄存器

能进行 32 位运算的寄存器分别称为 `EAX`、`EBX`、`ECX`、`EDX`、`ESI`、`EDI`、`EBP` 和 `ESP`。其中 `EAX`、`EBX`、`ECX`、`EDX` 的 **低 16 位** 构成了 16 位微处理器中的通用寄存器（去掉 E），然后 **低 16 位** 又可以进一步拆成 **两个 8 位** 通用寄存器。

#### 段寄存器

**6 个 16 位的段寄存器** 用于指示代码和数据所用的地址空间。代码段寄存器 `CS`、堆栈段寄存器 `SS`、`DS`、`ES`、`FS` 和 `GS` 都称为数据段寄存器，除 `CS` 用于指示指令代码的地址空间外，其他段寄存器都用于指示 **数据** 的地址空间。当微处理器工作在 **实地址模式** 下，这些段寄存器提供的内容就是 **16 位的段基址**

| 逻辑段 | 段基址存放 | 偏移地址存放                     | 初始值               |
| ------ | ---------- | -------------------------------- | -------------------- |
| 代码段 | CS         | IP                               | 操作系统赋值         |
| 堆栈段 | SS         | SP                               | 程序员或操作系统赋值 |
| 数据段 | DS         | 根据不同的寻址方式选择 BX、SI、DI | 程序员赋值           |
| 附加段 | ES/FS/GS   | 根据不同的寻址方式选择 BX、SI、DI | 程序员赋值           |

#### 指令指针寄存器

`EIP` 中存放相对于代码段寄存器 `CS` 的基址的偏移量。`EIP` 的低 16 位可作为独立使用的寄存器，称为 `IP`, 它在实地址模式下，与 `CS` 组合后，形成 20 位的物理地址

#### 标志寄存器

标志寄存器是 32 位的寄存器，称为 `EFLAGS`。`EFLAGS` 中的位同样分为状态标志位和控制标志位两类：

+ 状态标志位指明程序运行时的微处理器的实时状态，这种状态会像某种先决条件一样影响后面的操作。有 SF、ZF、PF、CF、AF 和 OF
+ 控制标志位由程序设计者设置，有 DF、 IF、 TF。每个控制标志都对某一种特定的功能起控制作用
+ `EFLAGS` 的低位也可作为一个独立的标志寄存器 `FLAGS`（又称为程序状态字 `PSW`）来使用。

## 32 位微处理器工作模式

> 80x86 系列的 32 位微处理器（80386 及其后继处理器）支持 16 位和 32 位指令系统，32 位指令系统是在 16 位指令系统的基础上扩展而成的。32 位处理器有 3 种工作模式：实地址模式（Real Address Mode)、保护虚拟地址模式(Protected Virtual Address Mode)和虚拟 8086 模式，简称为实模式、保护模式和虚拟 86 模式。

### 32 位微处理器地址空间

80X86 系列的 32 位微处理器有 3 个明确的存储地址空间，它们是 **物理空间**、**虚拟空间** 和 **线性空间**。

+ 物理空间是计算机中主存储器的实际空间，也称为主存空间，相应的地址称为 **物理地址** 或 **主存地址**。任一存储单元都具有唯一的一个物理地址。对主存的访问最终必须通过物理地址来实现。32 位微处理器有两个独立的物理空间：一个是 **物理存储空间**，另一个是 **物理 I/O 空间**。80X86 的物理 I/O 空间由$2^{16}(64K)$个地址组成。它与存储地址不重叠
  + 8086：20 根地址线，寻址范围$1M$
  + 80486：32 根地址线，寻址范围$4GB$

+ **虚拟空间又称为逻辑空间**，是应用程序员编写程序的空间，此空间对应的存储器称为虚拟存储器，该存储空间对应的地址称为虚拟地址或逻辑地址。该空间可比主存实际能提供的空间大很多，即使主存空间不够大，也能运行程序员编写的程序
+ 32 位微处理器通过 **分段部件** 把虚拟空间变换为 32 位的 **线性空间**，如果分页部件未被选用（实模式），线性地址就是物理地址

### 32 位微处理器工作模式

#### 实地址模式

> 在实模式下，32 位微处理器与它的前款处理器 16 位的 8086 兼容，所以为 8086、80286 编写的程序不需要做任何修改，就可以在 32 位微处理器的实模式下运行，且速度更快。除此之外，在实模式下，还能有效地使用 8086 所没有的寻址方式、32 位寄存器和大部分指令。在实模式下，32 位微处理器具有与 8086 同样的基本体系结构。

实地址的特点：

1. 加电、复位之后，486 自动工作在实模式，系统在 DOS 管理下
2. 在实模式下，微处理器的地址线仅低 20 根启动，所以 486 只能访问最低端的 $1M$ 内存（$00000H\sim FFFFFH$）
3. 存储管理部件对存储器只进行分段管理，**没有分页功能（线性地址即为物理地址）**，每一逻辑段的最大容量为 $64K$
4. 该模式下，段寄存器中存放段基址

实地址物理地址形成:star:

实地址模式下，物理地址的地址信息是 20 位的二进制代码，以 16 进制表示是 $00000H\sim FFFFFH$ 中的一个单元，CPU 访问存储器时，地址总线上送出的是 20 位物理地址。但是由于之前的 8086/8088 处理的数据总线宽度只有 16 位，无法传输 20 位的地址，所以在 **编程（虚拟）空间** 引入了 **逻辑地址**，即 **段地址：偏移地址** 的模式，即用 4 个 16 进制表示物理地址。

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220906103752.png" alt="image-20220906103752489" style="zoom:67%;" />

系统将内存分为若干个逻辑段（最大 $64K$），在同一逻辑段中，各单元的 16 位段地址是相同的，偏移地址是该单元相对于段首的 16 位地址偏移量。系统默认时，段都起始于 16 字节的边界，即段起始物理地址为 $XXXX0H$

+ 计算方法：将段地址左移 4 位后与偏移地址相加
  

> 段寄存器 `CS` 内容为 $1000H$，偏移地址在 `IP` 寄存器中，为 $2345H$
>
> <img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220906104115.png" alt="image-20220906104115472" style="zoom: 50%;" />

+ 物理地址唯一，逻辑地址不唯一（取决于分段的方式）

### 保护虚拟地址模式

特点：

1. 486 支持多任务操作系统
2. 486 可以访问 4G 物理存储空间
3. CPU 内部的存储管理部件对存储器采用分段和分页管理。可以将磁盘等存储设备有效映射到内存，使逻辑地址空间大大超过实际的物理地址空间，这样使主存储器容量似乎很大
4. 既能进行 16 位运算，也能进行 32 位运算。

保护机制：高级别的程序可以访问同级或低级的数据段，反之则不行

### 虚拟 8086 模式

> 32 位微处理器允许在实模式和保护模式下执行 8086 的应用程序。后者为系统设计人员提供了 32 位微处理器保护模式的全部功能，因而具有更大的灵活性。保护模式的功能之一是能够在保护和多任务的环境中直接执行实模式的 8086 软件，这个特性称为虚拟 8086 模式，又简称为虚拟 86 模式，这不是一种实际的处理器方式，而是一种准操作方式。虚拟 8086 模式具有保护方式下的任务属性。

1. 可以执行 8086 的应用程序
2. 段寄存器的用法和实模式一样，即段寄存器内容左移 $4$ 位加上偏移地址即为线性地址
3. 存储器寻址空间为 $1MB$
