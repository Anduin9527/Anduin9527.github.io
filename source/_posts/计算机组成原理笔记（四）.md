---
title: 计算机组成原理笔记（四）
tags:
  - 笔记
  - 硬件
category: 计算机组成原理
katex: true
abbrlink: 9194e09f
date: 2022-07-23 13:58:07
---

## 前言

摸了一周崛起，又回来上工了！

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220723135707.png" alt="image-20220723135707436" style="zoom:80%;" />

<!--more-->

## 概述

### 问题的提出

CPU 的发展速度非常快，而存储器的速度则会成为瓶颈，则 CPU 存在 **空等** 现象。通过在 CPU 和主存之间增加一个 Cache 缓存，其由静态 RAM 组成，和主存相比容量小，速度快。

> Cache 之所以行之有效，就不得不提 **程序访问的局部性原理**，这个原理的内含分两部分，一是时间的局部性：当前访问到的指令和数据在不久的将来很有可能还会被访问到；二是空间的局部性：当前访问的指令和数据的附近的指令和数据在不久的将来很可能会被访问到。因此，如果我们把当前访问的指令、数据及其附近的指令和数据都缓存到 Cache，那么之后再访问时，CPU 就无需访存了，进而提升了系统的性能。

### 主存和缓存的编址

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/Cache%E7%BB%93%E6%9E%84.png" alt="Cache结构" style="zoom:80%;" />

+ 内存被分为 $M$ 块，缓存被分为 $C$ 块，其块的大小相同都为 $B$ 个字。通常 $M \gg C$ ，这意味着同一时间内，只有一小部分的主存会被缓存
+ 主存中的数据都是按块被缓存的，当某块被缓存时，由硬件为 Cache 的每一块维护的标记会记录下被缓存的主存块的块号。之后 CPU 访问该块的数据时，在缓存的标记中可以找到该块的块号，且相应 **缓存块有效**，那么就不需要访存了，直接访问相应的缓存块即可

### 缓存的命中率

所谓 Cache 的命中，就是指 CPU 访问某个指令或数据时，其对应的主存块已经被写入缓存（已建立了对应关系/标记），反之则为未命中，CPU 必须到主存中去获取对应指令。

> CPU 多次访问数据，其中缓存命中的比率称为 Cache 的 **命中率**。命中率与 Cahce 的容量和块的大小有关，一般来说容量越大，块越大，则命中率越高。当然，凡是不能极端，缓存过大会提升成本和功耗，而块过大会减少块的数量，进而降低同一时间能够被缓存的主存块的数量。

总的来说，命中率 与 Cache 的 容量与块长有关。一般块长取一个存取周期内从主存调出的信息长度

#### 访问效率 $e$ 

$$
\begin{align*}
e &= \frac{t}{\overline t}*100\% 
\\&=\frac{t_c}{h *t_c+(1-h)* t_m}*100\% 
\end{align*}
$$

+ $t$ 为访问 Cache 的时间， $\overline t$ 为平均访问时间
+ 带入命中率 $h$ 后，t_c $为访问 Cache 的时间，$ t_m$为访问主存的时间

### 	Cache 的基本结构

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/Cache%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84.png" alt="image-20220721105528285" style="zoom:80%;" />

### Cache 读写操作

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/Cache%E8%AF%BB.png" alt="image-20220721110412863" style="zoom:80%;" />

写操作主要有两种方式：

+ 写直达法：写操作时既写入 Cache 也写入主存，写操作时间即为访问主存的时间，Cache 块退出时，不需要对主存执行写操作，因此 Cache 块的更新策略比较容易实现。
+ 写回法：写操作时只把数据写入 Cache 而不写入主存，写操作时间即为访问 Cache 的时间，当 Cache 数据被替换出去时需要写回主存，因此增加了 Cache 的复杂性。

### Cache 改进

+ 增加 Cache 的层次级数：Cache 本质上通常是 SRAM，不过不同的单元电路组成的 SRAM 是有区别的，有的速度快、功耗高、成本高，有的速度慢、功耗低、成本低、且易于集成(具体内容可搜索 LVT HVT 关键字)。因此，参照整个存储系统的层次结构，Cache 也可以细分出不同层次，比如 L1 Cache、L2 Cache 等，以此来获得性能、功耗、芯片面积、成本等方面的平衡。
+ 参照哈佛架构分立缓存：采用独立的数据 Cache 和指令 Cache。现代处理器基本上都采用了流水线结构，如果单独为数据和指令设置 Cache，则在某条指令执行需要访问数据时，不会影响后面的指令的取指(一个是访问数据 Cache，一个是访问指令 Cache)，从而提高计算机的性能。

## 主存地址映射

### 直接映射

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E7%9B%B4%E6%8E%A5%E6%98%A0%E5%B0%84.png" alt="image-20220721112338281" style="zoom:80%;" />

首先要对主存按照缓存块的大小进行划分成不同的区，每个区的第一个字块都放置于 Cache 存储体中的第 0 块。CPU 给出的主存地址可以分成三个部分：区号（主存字块标记），块号（Cache 字块地址），偏移地址（字块内地址）。这种结构的优点是结构简单、速度快，缺点是在 Cache 有很多空闲的情况下仍出现 Cache 冲突，影响 Cache 利用率。

### 全相联映射

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E5%85%A8%E7%9B%B8%E8%81%94%E6%98%A0%E5%B0%84.png" alt="全相联映射" style="zoom:80%;" />

从全相联的结构可知，这种结构相较直接映射能够提高 Cache 的利用率，因为一个主存块可以被缓存到任一缓存块。但缺点也正是源于此，无法根据主存地址确定地址所在主存块会被缓存到哪个缓存块，因此在检查缓存是否命中时，需要多个比较器同时比较主存地址中主存块的块号和所有缓存标记，造成电路结构复杂，功耗也更高。

### 组相联映射

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E7%BB%84%E7%9B%B8%E8%81%94%E6%98%A0%E5%B0%84.png" alt="image-20220721115852678" style="zoom:80%;" />

直接映射中，一个主存块只可能被缓存到某个特定的缓存块；全相联映射正好相反，一个主存块可以被缓存到任一缓存块。可以说这两种方式走了两个极端，各有优缺点，而组相联映射是前两种映射方式的折中，实现了一个主存块可以被缓存到若干个缓存块(**一组缓存块**)中：

## 替换算法

### FIFO

先进先出置换算法。这个就是类似于队列，先装入的页面先被置换掉。易于实现但是有可能淘汰频繁使用的页面，效果不好。

### LRU

将近期内最久末被访问过的 Cache 块置换出去。

LRU 算法是指: 会为每一个 Cache 块设置一个“计数器”，用于记录每个 Cache 块究竟有多长时间没有被访问了。在替换时直接选取“计数器”最大的替换即可。

-   命中时，所命中的行的计数器清零，比其低的计数器+1，其余不变
-   未命中且还有空闲行时，新装入的行的计数器置为 0，其余非空闲行全+1
-   未命中且没有空闲行时，计数器最大的行的信息块被淘汰，新装入行的计数器置为 0，其余全+1

### LFU

将一段时间内被访问次数最少的那块从 Cache 中置换出去

LFU 算法会为每一个 Cache 块设置一个计数器，用于记录每个 Cache 块被访问过几次，当 Cache 块满后会替换计数器最小的

-   新调入的块计数器为 0，之后每访问一次计数器就+1。需要替换时，选择计数器最小的一行替换
-   若有多个计数器最小的行，可以按照行号递增或 FIFO 策略进行选择

### 随机替换

随机确定将哪块从 Cache 中替换出去。
## 辅助存储器

其不能直接与 CPU 进行信息交换，最常用的辅助存储器是 **磁表面辅助存储器**

### 磁表面辅助存储器

#### 技术指标

1. 记录密度：
   1. 道密度 $D_t$ ：沿磁盘半径方向单位长度上的磁道数，单位为道/英寸
   2. 位密度 $D_b$ ：磁道单位长度上能记录的二进制代码位数，单位为位/英寸
2. 存储容量：一个硬盘存储器所能存储的字节长度， $C = n \times k \times s$ 
3. 平均存取时间：存取时间是指从发出读写命令后。磁头从某一起始位置移动至新的记录位置，到开始从盘片表而读出或写入信息所需要的时间。**这段时间由两个数值决定，一个是将磁头定位至所要求的磁道所需的时间，称为定位时间或寻道时间：另一个是寻道完成后至磁道上需要访问的信息到达磁头下的时间，称为等待时间**，这两个时间都是随机变化的，因此往往使用平均值来表示。平均存取时间等于平均寻道时间与平均等待时间之和。平均寻道时间是最大寻道时间与最小寻道时间的平均值。
4. 数据传输率：磁盘存储器在单位时间内向主机传送数据的字节数，叫数据传输率， 传输率与存储设备和主机接口逻辑有关。从存储设备考虑，假设磁盘旋转速度为 $n$ 转/秒，每条磁道容量为 $N$ 个字节，则数据传输率 $D_r = D_b \times V(Bps)$ , 其中 $D_b$ 为位密度， $V$ 为磁盘旋转的线速度。
5. 误码率：出错的信息位数与读出信息位总数之比 

#### 磁记录原理

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E7%A3%81%E7%9B%98%E5%86%99.png" alt="image-20220723131552620" style="zoom:80%;" />

通过写线圈通入方向不一样的电流来写入改变局部磁化单元的朝向，从而记录 0 与 1

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E7%A3%81%E7%9B%98%E8%AF%BB.png" alt="image-20220723131807182" style="zoom:80%;" />

读写头在磁场中运动，切割磁力线，产生不同方向的电流，磁通与电势都发生变化，从而读取 0 和 1。

### 硬磁盘存储器

硬磁盘存储器的类型：

1. 固定磁头和移动磁头
2. 可换盘和固定盘

硬磁盘存储器的结构：

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/%E7%A1%AC%E7%A3%81%E7%9B%98%E7%BB%93%E6%9E%84.png" alt="image-20220723132957919" style="zoom:80%;" />

+ 磁盘控制器接受来自主机的指令，转换为磁盘驱动器的控制命令。实现主机与驱动器之间的数据格式转换
+ 盘片由硬质铝合金材料制成

### 软磁盘存储器

时代的眼泪，就速度而言不如硬盘，磁头来说软盘的磁头都是活动的，盘片为可更换，价格低廉但是容易损坏。

### 光盘存储器

采用光存储技术，利用激光进行读写，第一代技术采用非磁性介质，不可擦写。第二代技术采用磁性介质后可以擦写。