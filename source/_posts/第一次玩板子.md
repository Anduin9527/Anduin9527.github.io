---
title: 'WOC: 第一次玩板子'
tags: Linux
categories: 项目经历
abbrlink: 84a02bf2
date: 2021-01-27 14:14:35
---



### 前言

记录南邮校科协 linux 组寒假 WOC（winter of coding？？）的经历。

有组长（虞尧学长）的保姆级 PDF，体验良好。

<!--MORE-->

## 工具

#### 硬件

1.LicheeZero 开发板（ARM 架构）
2.12864 OLED(I2C 接口，SSD1306 芯片)
3.电烙铁、焊锡丝
4.USB 转串口模块(由于板子是将串口作为终端，所以为了让 Xshell 可以通过 usb 口连接到终端，还需要这
样一个模块)
4.杜邦线若干(用于连接各个硬件设备)
5.TF 卡、读卡器
6.USB A to Micro USB 连接线(用于连接 lichee zero 和电脑)

#### 软件

1.ubuntu20.04 LTS（WSL）

2.Xshell

3.VMware Pro

4.Kali20.04

## 一些概念

系统上电---> bootrom---> uboot---> kernel 加载---> init---> 应用程序

### UBOOT

U-Boot，全称 Universal Boot Loader，是遵循 GPL 条款是一个开源项目，用于启动操作系统内核，操作系统并不是一开机就会自动启动，是要有引导程序的。就类似于 BIOS 一类的存在

#### 结构

```
├── api                存放uboot提供的API接口函数
├── arch               平台相关的部分我们只需要关心这个目录下的ARM文件夹
│   ├──arm
│   │   └──cpu
│   │   │   └──armv7
│   │   └──dts
│   │   │   └──*.dts 存放设备的dts,也就是设备配置相关的引脚信息
├── board              对于不同的平台的开发板对应的代码
├── cmd                顾名思义，大部分的命令的实现都在这个文件夹下面。
├── common             公共的代码
├── configs            各个板子的对应的配置文件都在里面，我们的Lichee配置也在里面
├── disk               对磁盘的一些操作都在这个文件夹里面，例如分区等。
├── doc                参考文档，这里面有很多跟平台等相关的使用文档。
├── drivers            各式各样的驱动文件都在这里面
├── dts                一种树形结构（device tree）这个应该是uboot新的语法
├── examples           官方给出的一些样例程序
├── fs                 文件系统，uboot会用到的一些文件系统
├── include            头文件，所有的头文件都在这个文件夹下面
├── lib                一些常用的库文件在这个文件夹下面
├── Licenses           这个其实跟编译无关了，就是一些license的声明
├── net                网络相关的，需要用的小型网络协议栈
├── post              上电自检程序
├── scripts           编译脚本和Makefile文件
├── spl               second program loader，即相当于二级uboot启动。
├── test              小型的单元测试程序。
└── tools             里面有很多uboot常用的工具。
```

修改 include/configs/sun8i.h

![image-20210320111620165](https://i.loli.net/2021/03/20/HebqMxLQw6dfcau.png)

+ 这是是告知 U-BOOT 在引导启动的时候在相应的内存地址寻找并载入相应的“包”

```bash
sudo ARCH=arm make menuconfig //进行内核选项的调整
```

### LinuxKernel

系统内核（Kernel）是整个操作系统的最底层，它负责整个硬件的驱动，以及提供各种系统所需的核心
功能，包括防火墙机制、是否支持 LVM 或 Quota 等文件系统等等，如果内核不认识某个最新的硬件，那
么硬件也就无法被驱动，你也就无法使用该硬件。计算机真正工作的东西其实是硬件，例如数值运算要
使用到 CPU、数据储存要使用到硬盘、图形显示会用到显示适配器、音乐发声要有音效芯片、连接
Internet 可能需要网络卡等等。内核就是控制这些芯片如何工作。

Linux 内核由如下几部分组成：内存管理、进程管理、设备驱动程序、文件系统和网络管理等。

+ FUN ：内核不能调 C 库函数

+ 默认配置就好，但是我为了后续的利用 OTG 共享网络这里就设置了一下 USB GADGET
+ device drivers-> usb support > usb gadget support

![](https://i.loli.net/2021/03/20/WJbmwMkGLutFgZB.png)

### buildroot

buildroot 是一个简单以及自动化的工具，可以使用交叉编译为嵌入式系统构建一个完整的 linux 系统。为了实现这个功能，buildroot 可以生成交叉工具链，rootfs，linux kernel 镜像和 bootloader。并且 buildroot 可以适用于以上资源的任意组合情况

### 驱动

linux 系统将设备分为 3 类：**字符设备、块设备、网络设备**。

系统调用通过设备文件的 **主设备号** 找到相应的设备驱动程序（每一个字符设备或块设备都在 **/dev** 目录下对应一个设备文件。），然后读取这个数据结构相应的函数指针，接着把控制权交给该函数，这是 Linux 的设备驱动程序工作的基本原理。

以字符设备驱动编写为例：

+ 确定主设备号（用于识别设备文件，在驱动程序代码中，我们可以将这些数字定义为常量）, 也可以让内核分配
+ 定义 **file_operations** 结构体
+ 手动实现对应的 drv-open/drv-read/drv-write 等函数, 填入 file_operations 结构体
+ 把 file-operations 结构体告诉内核
+ 安装驱动程序时, 就会去调用入口函数(module_init)
+ 卸载驱动程序时, 调用出口函数(module_exit)

## 踩坑

### 1.ARCH = arm make menuconfig

报错信息：

```bash
HOSTCC  scripts/kconfig/mconf.o
<command-line>: fatal error: curses.h: No such file or directory
compilation terminated.
make[1]: *** [scripts/Makefile.host:116: scripts/kconfig/mconf.o] Error 1
make: *** [Makefile:478: menuconfig] Error 2
```

解决：([chentao1206](https://blog.csdn.net/chentao1206))[https://blog.csdn.net/chentao1206/article/details/51280610]

在 **Debian/ Ubuntu Linux** 系统中，我们可以使用以下命令来安装 ncurses:

```bash
sudo apt-get install libncurses5-dev libncursesw5-dev
```

在 **RHEL / Fedora / CentOS Linux** 中，我们使用以下命令：

```bash
yum install ncurses-devel ncurses
```

### 2.Buildroot 编译 Error

Win10 WSL 系统下编译 buildroot 报错不支持 SYSV IPC，导致 fakeroot 无法正常工作 

报错信息：

```bash
fakeroot, while creating message channels: Function not implemented
This may be due to a lack of SYSV IPC support.
fakeroot: error while starting the `faked' daemon.
kill: usage: kill [-s sigspec | -n signum | -sigspec] pid | jobspec ... or kill -l [sigspec]
make: *** [fs/tar/tar.mk:32: /home/anduin9527/buildroot-2017.08.1/output/images/rootfs.tar] Error 1
```

解决：[Error while building rootfs system for Raspberry Pi 3 using Buildroot - lack of SysV IPC support](https://stackoverflow.com/questions/45469650/error-while-building-rootfs-system-for-raspberry-pi-3-using-buildroot-lack-of)

修改 buildroot-> fs 目录下的 common.mk 文件，如下所示：

```c
# 将以下
PATH= $$(BR_PATH) $  $(HOST_DIR)/bin/fakeroot -- $ $(FAKEROOT_SCRIPT)
# 修改为：
if [ `uname -r | grep "Microsoft"` ] ; then \
    cp -f `which fakeroot-tcp` $$(HOST_DIR)/bin/fakeroot ; fi
```

### 3.Buildroot 编译完之后没有生成 rootfs.tar

解决：不用 buildroot 😟，跳向 **debootstrap** 的坑。

### 4. debootstrap --foreign --verbose --arch = armhf stretch rootfs

报错信息：

```
Failed getting release file http://ftp2.cn.debian.org/debian/dists/stretch/Release
```

解决：[Failed getting release file while running debootstrap with sudo](https://unix.stackexchange.com/questions/334303/failed-getting-release-file-while-running-debootstrap-with-sudo)

```bash
sudo debootstrap --foreign --verbose --arch=armhf  stretch rootfs https://mirrors.tuna.tsinghua.edu.cn/debian/
```

https://mirrors.tuna.tsinghua.edu.cn/debian/比 http://ftp2.cn.debian.org/debian 快

### 5.DEBIAN 解压

报错信息：

```bash
chroot: failed to run command '/debootstrap/debootstrap': Exec format error
```

解决：[Ubuntu 虚拟机使用 Debos 构建 Debian10](https://blog.csdn.net/m0_38096844/article/details/104625198)

```
sudo apt-get remove qemu-user-static     #卸载
sudo apt-get install qemu-user-static    #重装
sudo update-binfmts --enable             #构建之前运行
```

### 6.sudo LC_ALL = C LANGUAGE = C LANG = C chroot rootfs

报错信息：

```bash
chroot: failed to run command '/bin/zsh': No such file or directory
```

解决：

```bash
exec bash
```

### 7.WSL 烧录问题 ||（太折磨，玩板子慎用 WSL）

[解决 WSL 烧录 SD 卡问题](https://blog.csdn.net/Rspate/article/details/109012675)

还是等巨硬出 WSL3 吧

解决：用 VMware+Kali ()

### 8.VM 没有自动识别 TF 卡

解决：

![image-20210128115617468](https://i.loli.net/2021/01/28/zny4adput8EcHZi.png)

看到那个 USB 头了吗，点他。

参考：[吐血经验！！！解决虚拟机连不上 USB！最全！](https://blog.csdn.net/qq_18649781/article/details/79941310?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control&depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-1.control)

### 9.链接 Xshell 报错并打印乱码

![image-20210212232052093](https://i.loli.net/2021/02/12/MaSNIUcg2ey1Rnw.png)

在我经历了复盘，刷镜像，摸了十几天混入官方群后终于得到了答案：

![img](https://i.loli.net/2021/03/20/gv1AnEJmGwR5Qc6.png)

答应我，用好一点的 **电烙铁**，买好一点的 **杜邦线** 好吗

### 10.wifi

[荔枝派 zero 编译 rtl8723bs 驱动并连接 WiFi](https://blog.csdn.net/u012577474/article/details/104678522)

![image-20210321123347280](https://i.loli.net/2021/03/21/yJW1kZd4KT9wlBs.png)