---
title: Linux中的文件权限
tags:
  - Linux
  - 笔记
abbrlink: c66f2510
date: 2022-09-17 12:07:57
---

## 前言

Turn My Body into Fire！

Proposing a toast to David！

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220916222848.jpeg" alt="img" style="zoom: 45%;" />

<!--more-->

## 文件权限

在阅读之前，记住一件事，Linux 中的权限一般是指文件和用户（用户组）的对应关系，这会很大程度上帮助你理解

### 用户与用户组

Linux 的服务器属性注定了会有多用户使用一台机器的需求，所以为了用户之间尽可能不要互相干扰，系统管理员必须做好用户管理，这又是另一个专业的问题了，这里不过多赘述。对于权限部分的知识，只需要知道：

每个用户都有唯一标识符 `UID`，其与用户名是一一对应关系。系统会在登录的时候通过查询 `/etc/passwd` 文件来确定用户的 `UID` 和主目录。该文件的每一行都描述了一个用户，包含由冒号分隔的 7 个部分

```
root:x:0:0:root:/root:/bin/bash
```

从左到右依次是：登录名：加密密码的预留位置：`UID`：`GID`：[GECOS 信息]（可选项）：主目录：登录 `shell`

Linux 将用户分为三种：超级用户、虚拟用户以及普通用户。超级用户自然就是 root，其 `UID` 为固定的 0；虚拟用户是为了满足系统进程对文件资源的访问控制而建立的，所以不能用来登录，比如各种 web 服务，daemon，ftp 等等，其 `UID` 为 1~499

Linux 中，每个用户都可以拥有多个 **用户组**，但必须有一个作为主用户组，剩余的作为附加用户组，属于某用户组的用户对于某些文件拥有相同的权限。与 `/etc/passwd` 类似，用户组的信息存放在 `/etc/group` 中，其包含了每个组的名称以及每个组的成员列表。每一行包含四个字段：组名，加密后的密码，`GID`，组成员列表

> 以下是一些更改用户及用户组的命令，但对于本节内容并不重要，所以不多赘述
>
> `groupadd` 添加用户组，`groupdel` 删除用户组，`groupmod` 修改用户组
>
> `passwd` 修改用户登录密码，`adduser` 添加用户，`userdel` 删除用户，`usermod` 修改用户

在用户和用户组之外，还有一个 **其他用户** 的概念。这个很好理解，比如一个用户张三，其主用户组是张三之家，那么在张三创建的文件看来，隔壁老王既不是张三，也不是张三之家的成员，那么隔壁老王就是 **其他用户**

### 文件属性

首先，还是从 `ls -l` 说起吧，他会以长列表（详情）的方式展示当前目录，这里截取其中一条用以说明

```
drwxr-xr-x  3 root       root           4096 Sep 10 17:43 postgres/
```

+ 第一栏的第一个字符 **d**，表示这个文件是一个 **目录**

  > **-** 表示普通文件
  >
  > **d** 表示目录，通过 `mkdir` 创建，通过 `rmdir` 删除
  >
  > **l** 表示链接文件，通过 `ln -s` 创建
  >
  > **b** 表示块设备文件，例如可供储存的设备，通过 `mknod` 创建
  >
  > **c** 表示字符设备文件，例如键盘、鼠标，通过 `mknod` 创建
  >
  > **s** 表示本地域套接字，通过 `socket` 系统调用
  >
  > **p** 表示具名管道，通过 `mknod` 创建

+ 接下来的字符中，以三个为一组，且均为 `rwx` 的三个参数的组合。其中，`r` 代表可读（read）、`w` 代表可写（write）、`x` 代表可执行（execute）。 没有对应权限，就会出现减号 `-`。三组 `rwx` 依次代表了所属用户 user，所属用户组 group 和其他用户 other 的访问权限

+ 为了简单起见，我们用三位 8 进制数表示这三组权限，其中 4 表示 `r`，2 表示 `w`，1 表示 `x`，然后每组的权限相加即可，比如 `rwxrwxrwx` 就可以表示为 777，反之 `---------` 表示为 000

+ 第二栏的数字表示有多少文件名链接到该节点，这部分涉及了 Linux 的 `i-node` 设计，这里简单地理解为有多少文件可以直接访问到该文件即可

+ 第三栏和第四栏分别表示该文件的所属用户和所属用户组，初始情况下为创建该文件的用户

+ 第五栏表示文件大小，单位为 `Bytes`

+ 第六栏表示该文件的创建或是最近修改日期

+ 第七栏自然就是文件的名称

### 文件权限的意义？

#### 文件

文件是实际含有数据的地方，包括一般文本文件、数据库内容档、二进制可执行文件等等

- r （read）：可读取此一文件的实际内容，如读取文本文件的文字内容等
- w（write）：可以编辑、新增或者是修改该文件的内容，**但不含删除该文件**
- x （execute）：该文件具有可以被系统执行的权限

#### 目录

目录主要的内容在记录文件名清单

- r （read contents in directory）：

  表示具有 **读取目录结构清单的权限**，所以你具有读取一个目录的权限时，表示你可以使用 `ls` 命令查询该目录下的文件名数据。

- w （modify contents of directory）：

  表示你具有改动该目录结构清单的权限，具体来说：

  - 创建新的文件与目录
  - 删除已经存在的文件与目录（**无视该文件的本身权限要求**，但是可以用下文提到的 Sticky 解决）
  - 将已存在的文件或目录进行更名
  - 移动该目录内的文件、目录位置

- x （access directory）：

  目录不可以被执行，目录的 `x` 代表的是使用者能否使用 `cd` 命令进入该目录并使之成为工作目录。 所谓的工作目录（work directory）就是指当前所在目录（用 `pwd` 命令查询）

也许你还感觉比较抽象，接着我们用一个比喻来说明这些目录权限的意义：

1. 目录看作带有一个 **半透明** 的抽屉，文件看作在抽屉中的一个个密封的文件袋
2. 目录的 `x` 权限决定你能否拉开 `cd` 这个抽屉；`w` 权限决定你能否放置，丢弃其中的文件袋；`r` 权限决定这个抽屉里的 **昏暗的小灯** 是否打开，即你是否能看见（`ls`）里面文件的 **名称**
3. 为什么叫昏暗的小灯呢？因为如果你使用 `ls -l`，你会发现除了最后的文件名和第一个文件类型，剩余的信息全部都是 `?`。可以想象这样一个场景，你在半透明抽屉外面透过内部昏暗的灯光（只拥有 `r` 权限）勉强能分辨出 **文件类型和文件名称**，但剩余的信息需要你 **拉开抽屉**（拥有 `x` 权限）才能得到
4. 但灯光 `r` 也只是辅助你看到文件名称，文件的存在与否与灯光没有关系。所以当你拥有 **拉开抽屉** 的权限时，只要你 **记得** 在黑暗中（这时 TAB 就无效了）有哪些文件，你仍然可以使用一些命令查看或修改他们（只要你拥有对文件本身的具体权限）
5. 接着是目录的 `w` 权限，这很好理解，如果我无法拉开抽屉（没有 `x` 权限），那我即使拥有 `w` 权限也不能在其中新建或者删除文件。但一旦张三同时拥有了某个目录的 `wx` 权限，那就可以获得里面所有文件的生杀大权。比如张三无法查看修改李四放在这个目录的的文件，但他可以直接把这个文件丢掉（`rm`）

| 权限    | 文件           | 目录                   |
| ------- | -------------- | ---------------------- |
| r(读)   | 查看文件内容   | 浏览目录内容           |
| w(写)   | 修改文件内容   | 在目录中创建文件或目录 |
| x(执行) | 将文件投入运行 | 进入目录               |

### 扩展权限

Linux 系统中的基本权限位为 9 位权限，加上 3 位特殊权限位，共 12 位权限。

1. SUID（setUID）

   只有 **可以执行的二进制程序** 才能设置 `SUID` 位，**且用户必须拥有该文件的可执行权限**，当用户在 **执行** 该文件时，用户临时拥有该文件 **所属用户** 的权限，直到程序执行结束。表现为所属用户的 `x` 变为 `S`（原本无执行权限）或者 `s`（原本有执行权限）

   常见的栗子就是 ` /etc/shadow ` 文件的权限是 `000 root root`，而更改密码的命令 `/bin/passwd` 本质上就是修改这个文件，所以按照道理来说，普通用户无法修改 `shadow` 文件，也就无法更改密码。但是因为 `passwd` 的权限设置为 `rwsr-xr-x root root`，其所属用户部分的 `s` 表示 `passwd` 命令拥有 setUID 权限，因此一个普通用户在执行该命令时，会 **临时** 获得 **文件所属用户** 也就是 **root** 的权限！而 root 则是可以为所欲为的！同样的，我们最常使用的 `sudo` 命令也是利用了这一机制

2. SGID（setGID）

   同样的，只有 **可以执行的二进制程序** 才能设置 `SGID` 位，**且用户必须拥有该文件的可执行权限**，当用户在 **执行** 该文件时，用户临时拥有该文件 **所属用户组** 的权限，直到程序执行结束。表现为所属用户组的 `x` 变为 `S`（原本无执行权限）或者 `s`（原本有执行权限）

   常见的栗子，对于设定了 SetGID 权限的目录来说，普通用户在此目录中的有效组会变成此目录的所属组，若普通用户对此目录拥有 w 权限时，在目录中新建的文件的默认所属组是这个目录的所属组。

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20220917010335.png" alt="未命名绘图.drawio" style="zoom:80%;" />

> 所以这两个特殊权限并不是直接 **分享权限**，而是 **分享角色**

3.  Sticky

   Sticky BIT 表示的是粘着位，主要是用来避免其他用户对文件的误操作。表现为 **其他用户** 的 `x` 变为 `T`（原本无执行权限）或者 `t`（原本有执行权限）
   粘着位目前只对目录有效，普通用户要对该目录拥有 `w` 和 `x` 权限，即普通用户可以在此目录拥有写入权限。如果没有粘着位，因为普通用户拥有 `w` 权限，所以可以删除此目录下所有文件，包括其他用户建立的文件。一但赋予了粘着位，除了 root，目录所属用户，文件所属用户可以删除对应文件，普通用户就算拥有 `w` 权限也只能删除自己建立的文件，但是不能删除其他用户建立的文件，给予公共文件夹 `/tmp` 一些安全性

与 `rwx` 类似的，我们令 `SUID` 为 4，`GUID` 为 2，`Sticky` 为 1，用一个 8 进制数表示三个扩展权限，并把这个八进制数放置在之前的三组权限前形成 4 个八进制数的表示方法

### 改变文件权限

改变文件的权限，需要用到 `chmod` 命令，其有两种语法形式

1. chmod [ugoa] [+-=] [rwxst] 文件列表（空格分隔）

   > `u` 符号代表当前用户
   >
   > `g` 符号代表和当前用户在同一个组的用户，以下简称组用户
   >
   > `o` 符号代表其他用户
   >
   > `a` 符号代表所有用户
   >
   > `r` 符号代表读权限以及八进制数 `4`
   >
   > `w` 符号代表写权限以及八进制数 `2`
   >
   > `x` 符号代表执行权限以及八进制数 `1`
   >
   > `X` 符号代表如果目标文件是可执行文件或目录，可给其设置可执行权限
   >
   > `s` 符号代表设置权限 suid 和 sgid，使用权限组合 `u+s` 设定文件的用户的 ID 位，`g+s` 设置组用户 ID 位
   >
   > `t` 符号代表设置 Sticky，只有目录或文件的所有者才可以删除目录下的文件
   >
   > `+` 符号代表添加目标用户相应的权限
   >
   > `-` 符号代表删除目标用户相应的权限
   >
   > `=` 符号代表添加目标用户相应的权限，**删除未提到的权限**

2. chmod 八进制权限值 文件列表（空格分隔）

   > 777 代表 `rwxrwxrwx`
   >
   > 666 代表 `rw-rw-rw-`
   >
   > 1111 代表 `--x--x--t`

### 权限掩码

`umask` 是进程的一个属性，目的是为进程创建的文件或目录定义默认权限，它是进程运行环境的一部分

Shell 创建的所有子孙都将继承这一属性，用户可通过 `umask` 命令修改 `umask` 的值，语法为 `umask` 八进制权限值

## 参考

鸟哥的 Linux 私房菜（第四版）

Unix/Linux 系统管理技术手册（第五版）

https://blog.csdn.net/wxbmelisky/article/details/51649343