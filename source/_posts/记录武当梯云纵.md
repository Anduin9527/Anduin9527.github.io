---
title: 记录在 linux 上的武当梯云纵
tags:
  - 分享
  - 网络
categories: 项目经历
abbrlink: a04e8961
date: 2021-08-24 16:43:49
---

### 前言

手机和 PC 上都是直接 V2ray+机场直接走了，一直没认真配过，没想到一搞就是一天……

买的腾讯云学生机 git 速度感人 –> V2ray 客户端 –> git V2 速度感人 –> ……-> 白嫖 Azure 大失败 –> ……–> trojan 真好用

<!--more-->

### 工具

> 一台 ip 在国外的 VPS（我用的 [vultr](https://my.vultr.com/)，支持小时计费还有支付宝，一个人用最便宜的都绰绰有余）
>
> 一台 ip 在国内想要学武当梯云纵的 VPS
>
> 一个能正常使用的终端（Windows Terminal 好用的很）
>
> 一个闲置的域名（最好别备案，国内国外皆可）
>
> DNS 服务商（免费的 [cloudflare](https://www.cloudflare.com/zh-cn/)，当然你顺手在国内解析也行，不过大概率会被叫去实名）

### 服务端篇

#### 购买篇

因为只买过 vultr，所以只聊聊 vultr 的购买选项

**地区**

![image-20210824195804260](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210824195804.png)

+ 有些地区会有 2.5 刀的 only ipv6 版（考虑到目前中国的 ipv6 发展水平，最好别选），有些地区有 3.5 刀的青春版

**镜像**

![image-20210824200139053](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210824200139.png)

+ 一般来说就选 CentOS 和 Ubuntu/Debian 即可（别的我也没怎么用过）

**可选项（）**

+ Enable IPv6：分配个 IPv6 的地址给你
+ Enable Auto Backups：增值服务，自动备份。
+ Enable DDOS Protection：增值服务，防范 DDOS 攻击。
+ Enable Private Networking：分配个内网 IP 给你

总结：如果只是为了上武当学艺，这四个都可以不用

然后是 **Startup Script** 和 **SSH Keys**。我选择朴实无华的自己 ssh，故也不填

最后 **Server Hostname** 随便填个名儿就行

返回主页，就可以看见自己的服务器正在加载，加载成功之后记住他的 IP 和 root 密码就行，vultr 默认没有防火墙，要是设置过防火墙记得打开 80（ssh）和 443（代理）端口

#### 域名解析篇

我们需要有一个域名作为伪装域名

**国内**

我们随便买完域名之后，如果是在腾讯云（阿里云）阿里云买的，则去其对应的后台

![image-20210824201801267](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210824201801.png)

然后填写自己的服务端 IP 即可

**国外**

在成功注册 cloudflare 之后会让你填写解析记录，如图所示填写即可，内容是服务端的 IP，注意代理状态一定要选仅限 DNS

![image-20210824202529566](https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210824202529.png)

弄好之后可以在 https://dns.tech/l 检验一下基本就没有问题 li

#### 上机篇

随便打开个终端用 ssh 连接你的服务器

```bash
ssh root@'your IP or Domain'
```

如果是初次登录，会提示在本地生成 ssh key，yes 即可

然后输入密码，成功进入服务器

安装前置软件 curl

Debian/Ubuntu：

```bash
apt install -y curl
```

CentOS：

```bash
yum install -y curl
```

然后执行一键安装脚本 

```bash
bash <(curl -sL https://s.hijk.art/trojan.sh)
```

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210824204000.png" alt="image-20210824204000807" style="zoom:67%;" />

+ trojan 端口：443 貌似是最快的，但是最近好像有些不稳定，一堆人被封掉了
+ 伪装站：是真的能上 2333
+ 允许搜索引擎 or 爬取网站：建议选择允许，耗不了几个流量，但是能给你的网站带来多元的正常流量，大大的良民
+ 然后就一路 enter 即可

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210824204510.png" alt="image-20210824204510388" style="zoom:67%;" />

可喜可贺！记住下面四行信息即可。

### 客户端篇

#### 安装篇

官方客户端过于“简约”，windows 客户端建议使用 V2rayN 或者 Clash for Windows，mac 客户端建议使用 ClashX，安卓客户端建议使用 V2rayNG。

欧可，重点是 linux 客户端上的配置，因为连接 github 太慢了，只能放弃舒服的一键脚本（我要是能一键脚本，我还配个 der）

自行找个镜像站下载

```bash
cd /usr/src && wget https://d2.netfiles.pw/trojan/trojan-1.16.0-linux-amd64.tar.xz
```

解压

```bash
tar xvf trojan-1.16.0-linux-amd64.tar.xz
```

修改配置文件

```bash
cd /usr/src/trojan
vim config.json
```

其配置文件很多，但我们只需要关注如下几个

```bash
"run_type": "client",				
"local_addr": "127.0.0.1",	//0.0.0.0也可	
"local_port": 1080,					//0~65535 挑个不会被占用的即可
"remote_addr": "xxx.xxx",		//您的域名
"remote_port": 443,					//国外服务器trojan的端口
"password": ["xxxxxxxxxxx"],//密码 可以有多个
```

+  [FATAL] fatal: load_verify_file: No such file or director，这时 ssl 中的 verify 和 verify_hostname 需要设置成 false，好像是证书的问题，选择一种懒人危险法

```bash
"verify": false,
"verify_hostname": false,
"cert": "",
```

接着配置 trojan service

```bash
vim /etc/systemd/system/trojan.service
```

复制如下代码进去

```bash
[Unit]
Description=trojan
After=network.target

[Service]
Type=simple
PIDFile=/usr/src/trojan/trojan.pid
ExecStart=/usr/src/trojan/trojan -c /usr/src/trojan/config.json -l /usr/src/trojan/trojan.log
ExecReload=/bin/kill -HUP \$MAINPID
Restart=on-failure
RestartSec=1s

[Install]
WantedBy=multi-user.target
```

这样之后就可以用 `systemctl start trojan` 来启动 trojan 了，除此之外

```bash
systemctl restart trojan 				重启trojan
systemctl stop trojan 					停止trojan
systemctl status trojan 				查看当前trojan状态
systemctl status trojan -l			查看当前trojan完整状态
systemctl enable trojan					设置开机启动
cat /usr/src/trojan/server.conf 查看trojan配置
cat /usr/src/trojan/trojan.log 	查看trojan日志
```

输入 `curl cip.cc --socks5 127.0.0.1:{you_local_port}` 检测结果

#### 其他小技巧

linux 下代理一般是通过 `http_proxy` 和 `https_proxy` 这两个环境变量，但是很多软件并不使用这两个变量，导致流量无法走代理（这又是另一个悲伤的故事了）。 而且直接更改这两个环境变量总是会导致某些奇奇怪怪的错误产生。所以在不使用 vpn 的前提下，linux 并没有转发所有流量的真全局代理。但是可以用 **proxychains-ng** 为程序指定走代理，从而变相达到全局代理。

**安装**

```bash
git clone https://github.com/rofl0r/proxychains-ng

cd proxychains-ng
./configure --prefix=/usr --sysconfdir=/etc
make 
make install
make install-config
cd .. && rm -rf proxychains-ng
```

**配置**

```bash
vim /etc/proxychains.conf
#socks4         127.0.0.1 9050 
socks5 					127.0.0.1 {you_local_port}
```

注释或删除掉最后一行的默认配置，然后添加你的代理端口，现在你只需要在程序前面加上 `proxychains4` 就可以走代理执行命令。

比如 `proxychains4 curl cip.cc`

**别名**

`proxychains4` 也太长了吧。所以给它取个别名把

```bash
#bash
vim ~/.bashrc
#zsh
vim ~/.zshrc
```

在末尾追加

```bash
alias pxy=proxychains4
```

然后退出

```bash
#bash
source ~/.bashrc
#zsh
source ~/.zshrc
```

### 回到心心念念的 v2ray

虽说 trojan 确实配置简单，但也是相对我的服务器一开始无法走代理而言的。既然现在可以走代理了，那么不如再来安装一次 V2ray！

#### v2ray-core

```bash
sudo bash <(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)
```

官网的一键安装只需要用到这个脚本，无奈在没有代理的情况下，笑死，根本没有 $SPEED$ ​。

然后我看了一眼脚本内容，但其实这个脚本有参数可以 **选择使用代理下载**。

```bash
-p, --proxy     
#Download through a proxy server, e.g., -p http://127.0.0.1:8118 or -p socks5://127.0.0.1:1080'
```

```bash
sudo pxy wget https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh
sudo bash install-release.sh -p socks5://127.0.0.1:{you_local_port}
```

不出意外的话应该就成功地安装完成了，而且官方脚本不需要我们自己写 `systemd` 配置，然后把 `trojan` 关一下。先不用管 v2ray 的服务。

```bash
 systemctl stop trojan
 ststemctl disable trojan
```

#### v2raya

`v2raya` 在 web 端提供了 GUI，省去了切换节点修改配置文件的麻烦。能像其他客户端一样一键订阅可太方便了。

Ubuntu(Debian)

```bash
wget -qO - https://apt.v2raya.mzz.pub/key/public-key.asc | sudo apt-key add -
echo "deb https://apt.v2raya.mzz.pub/ v2raya main" | sudo tee /etc/apt/sources.list.d/v2raya.list
sudo apt update
sudo apt install v2raya
```

CentOS

在 https://github.com/v2rayA/v2rayA/releases 下载对应的 rpm 包

```bash
wget https://github.com/v2rayA/v2rayA/releases/download/v1.5.1/installer_redhat_x64_v1.5.1.rpm
sudo y -i installer_redhat_x64_v1.5.1.rpm
```

**配置**

```bash
#打开2017端口
firewall-cmd --zone=public --add-port=2017 --permanent

# 启动 v2raya
systemctl start v2raya

# 开机自启 v2raya
systemctl enable v2raya

```

然后可以访问 `http://localhost:2017/` 或者 `http://{your_vps_IP}:2017/` 进行配置

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210827185428.png" alt="image-20210827185428715" style="zoom: 50%;" />

然后就可以通过导入订阅连接或者 Vmess 的方式（同其他端的操作一致）

最后是设置，将 socks5 端口改成之前的{your_local_port}这样就可以继续使用 pxy 进行全局代理

<img src="https://imgbed-1304793179.cos.ap-nanjing.myqcloud.com/typora/20210827185616.png" alt="image-20210827185616188" style="zoom:50%;" />

### 参考

[trojan 一键脚本](https://v2raytech.com/trojan-one-click-scrip/)

[Centos 7 安装 Proxychains 实现 Linux 代理](https://www.cnblogs.com/BOHB-yunying/articles/12205099.html)

[Trojan-Go Docs](https://p4gefau1t.github.io/trojan-go/basic/full-config/)

[v2rayA](https://github.com/v2rayA/v2rayA)
